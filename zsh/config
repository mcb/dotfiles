#---
# Completion
#---
autoload -Uz compinit
compinit -C

zstyle ':completion:*' menu yes select
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' # Case-insensitive completion

#---
# Prompt
#---
setopt PROMPT_SUBST

repo_indicator() {
  # Early return if not in a repo - faster than checking both
  if git rev-parse --is-inside-work-tree &>/dev/null; then
    echo " ðŸ“¦"
    return
  fi
  jj root &>/dev/null 2>&1 && echo " ðŸ“¦"
}

show_virtual_env() {
  if [[ -n "$VIRTUAL_ENV" && -n "$DIRENV_DIR" ]]; then
    echo "%F{green}($(basename $VIRTUAL_ENV))%f "
  fi
}

PROMPT='$(show_virtual_env)%1~$(repo_indicator) %# '

#---
# History
#---
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000

setopt APPEND_HISTORY           # Append history instead of overwriting
setopt SHARE_HISTORY            # Share history across sessions
setopt EXTENDED_HISTORY         # Add timestamps to history
setopt HIST_IGNORE_ALL_DUPS     # Don't record duplicates
setopt HIST_REDUCE_BLANKS       # Remove unnecessary blanks
setopt HIST_VERIFY              # Show command before executing from history

#---
# Directory Navigation
#---
setopt AUTO_CD                  # Auto cd without typing cd
setopt AUTO_PUSHD               # Push old directory onto stack
setopt PUSHD_IGNORE_DUPS        # Don't store duplicate directories
setopt PUSHD_SILENT             # Don't print directory stack
setopt PUSHD_TO_HOME            # Push to home when no argument
setopt CDABLE_VARS              # cd to path stored in variable

#---
# General Options
#---
setopt EXTENDED_GLOB            # Extended globbing syntax
setopt MULTIOS                  # Write to multiple descriptors
setopt LOCAL_OPTIONS            # Allow functions to have local options
setopt LOCAL_TRAPS              # Allow functions to have local traps
setopt COMPLETE_IN_WORD         # Complete from both ends of word
setopt CORRECT                  # Command correction
setopt IGNORE_EOF               # Don't exit on EOF (Ctrl-D)
setopt NO_BG_NICE               # Don't nice background tasks
setopt NO_HUP                   # Don't hang up background jobs
setopt NO_LIST_BEEP             # No beep on completion
unsetopt CLOBBER                # Don't overwrite with > (use >!)

#---
# External Integrations
#---
REPORTTIME=10                   # Print elapsed time when > 10 seconds

# kubectl completion
if (( $+commands[kubectl] )); then 
  source <(kubectl completion zsh)
fi

# jj completion
if (( $+commands[jj] )); then
  source <(jj util completion zsh)
fi

# direnv hook
if (( $+commands[direnv] )); then
  eval "$(direnv hook zsh)"
fi
